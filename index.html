<script>
const palabras = [
  "pa","pe","pi","po","pu",
  "aba","obo","ubu","ebe","ibi",
  "pasa","basa","pesa","mesa","pala","bala",
  "pudo","mudo","bata","bote","buzo","bebé","bicho","billete"
];

let stream = null, i = 0, activo = false;

const word = document.getElementById("word");
const info = document.getElementById("info");
const audio = document.getElementById("audio");
const btnStart = document.getElementById("start");
const btnStop = document.getElementById("stop");

function esperar(ms){ return new Promise(r => setTimeout(r, ms)); }

function elegirMimeType() {
  const opciones = [
    "audio/mp4;codecs=mp4a.40.2", // iPhone suele soportar esto
    "audio/mp4",
    "audio/aac",
    "audio/webm;codecs=opus",
    "audio/webm"
  ];
  for (const t of opciones) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
      return t;
    }
  }
  return ""; // deja que el navegador elija
}

async function pedirMicrofono(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    info.textContent = "Micrófono listo ✅";
    btnStart.disabled = false;
  } catch (e) {
    info.textContent = "Error al pedir micrófono: " + (e?.message || e);
  }
}

async function grabarUnaVez(duracionMs){
  return new Promise((resolve, reject) => {
    try {
      const mimeType = elegirMimeType();
      const chunks = [];

      const rec = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

      rec.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      rec.onerror = (e) => reject(e.error || e);

      rec.onstop = () => {
        try {
          const tipoFinal = rec.mimeType || (chunks[0] && chunks[0].type) || "audio/mp4";
          const blob = new Blob(chunks, { type: tipoFinal });
          resolve({ blob, tipoFinal, size: blob.size });
        } catch (err) {
          reject(err);
        }
      };

      rec.start();
      setTimeou
