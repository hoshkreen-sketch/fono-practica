<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#38bdf8">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>Fono Pr√°ctica (Ni√±os)</title>

<style>
  /* ===== ESTILO NI√ëOS ===== */
  body{
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: linear-gradient(180deg, #f7fbff, #eef7f3);
    margin:0; padding:16px;
  }

  .panel{
    max-width: 860px;
    margin: 0 auto;
    background:#fff;
    border-radius: 22px;
    padding: 14px;
    box-shadow: 0 12px 34px rgba(0,0,0,.08);
    border: 1px solid rgba(0,0,0,.06);
  }

  h1{
    font-size: 22px;
    margin: 2px 0 10px;
    text-align:center;
    color:#2b6cb0;
    font-weight: 900;
  }

  .row{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin: 10px 0;
    align-items:center;
  }

  input, select{
    padding:10px 12px;
    border-radius: 16px;
    border:2px solid #bee3f8;
    background:#f7fafc;
    text-align:center;
    font-size:15px;
    font-weight: 700;
    color:#0f172a;
  }

  .controls{
    display:flex;
    gap:10px;
    justify-content:center;
    flex-wrap:wrap;
    margin: 12px 0;
  }

  button{
    font-size: 16px;
    padding: 12px 18px;
    border-radius: 999px;
    border:none;
    font-weight: 900;
    background:#38bdf8;
    color:#fff;
    box-shadow: 0 8px 20px rgba(56,189,248,.25);
  }

  button.secondary{
    background:#94a3b8;
    box-shadow:none;
  }

  button:disabled{ opacity:.5; }

  /* C√°mara */
  .camShell{
    position: relative;
    max-width: 560px;
    margin: 10px auto 0;
  }

  video{
    width:100%;
    display:block;
    border-radius: 18px;
    border: 2px solid rgba(0,0,0,.08);
    background:#000;
    transform: scaleX(-1); /* espejo */
  }

  /* Palabra sobre la c√°mara */
  .overlayWord{
    position:absolute;
    left:50%;
    top:12px;
    transform:translateX(-50%);
    background: linear-gradient(180deg, #fff, #fef3c7);
    border: 2px solid #fde68a;
    border-radius: 16px;
    padding: 10px 14px;
    font-weight: 1000;
    font-size: 44px;
    line-height: 1.05;
    text-align:center;
    max-width: 92%;
    word-break: break-word;
    color:#92400e;
    box-shadow: 0 8px 18px rgba(0,0,0,.14);
    backdrop-filter: blur(6px);
    animation: pop .35s ease-out;
  }

  @keyframes pop{
    0%{ transform:translateX(-50%) scale(.85); opacity:0; }
    70%{ transform:translateX(-50%) scale(1.06); opacity:1; }
    100%{ transform:translateX(-50%) scale(1); }
  }

  /* Marco gu√≠a de boca */
  .mouthGuide{
    position:absolute;
    left:50%;
    top:60%;
    transform: translate(-50%, -50%);
    width: 62%;
    height: 32%;
    border: 4px dashed rgba(255,255,255,.9);
    border-radius: 18px;
    background: rgba(255,255,255,.08);
    box-shadow: 0 0 0 2px rgba(0,0,0,.15), 0 10px 30px rgba(0,0,0,.25);
    pointer-events:none;
  }

  /* Botones mini sobre c√°mara */
  .camBtns{
    position:absolute;
    right:10px;
    bottom:10px;
    display:flex;
    gap:8px;
  }

  .mini{
    font-size: 13px !important;
    padding: 8px 10px !important;
    border-radius: 12px !important;
    background:#fbbf24 !important;
    color:#78350f !important;
    font-weight: 1000 !important;
    box-shadow: 0 8px 16px rgba(251,191,36,.25) !important;
  }

  /* Diferencias resaltadas */
  .sep{ opacity:.55; padding:0 10px; font-weight:900; }
  .diff{
    text-decoration: underline;
    text-decoration-thickness: 4px;
    text-underline-offset: 4px;
    padding: 0 2px;
    border-radius: 8px;
    background: rgba(239,68,68,.12);
  }

  /* Progreso */
  .progressWrap{
    max-width: 560px;
    margin: 12px auto 0;
    border: 1px solid rgba(0,0,0,.08);
    border-radius: 999px;
    overflow: hidden;
    height: 12px;
    background: #e0f2fe;
  }
  .progressBar{
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #22c55e, #4ade80);
    transition: width .08s linear;
  }

  audio{ width:100%; margin-top:12px; }

  .info{
    text-align:center;
    color:#475569;
    margin-top:10px;
    font-size:14px;
    font-weight: 700;
  }
  .small{
    text-align:center;
    color:#64748b;
    font-size:12px;
    margin-top:8px;
    font-weight: 600;
  }
</style>
</head>

<body>
<div class="panel">
  <h1>üåà Fono Pr√°ctica (Ni√±os)</h1>

  <div class="row">
    <label>
      Ejercicio:
      <select id="mode">
        <option value="series">Series (pa/pe/pi‚Ä¶ + aba/obo‚Ä¶)</option>
        <option value="pvb">Discriminaci√≥n P / B</option>
        <option value="pvm">Discriminaci√≥n P / M</option>
        <option value="vocabB">Vocabulario con B</option>
        <option value="corto">Sesi√≥n corta suave</option>
      </select>
    </label>

    <label>Hablar:
      <input id="talkSecs" type="number" min="1" max="10" step="0.5" value="2.5">
    </label>

    <label>Escuchar:
      <input id="listenSecs" type="number" min="1" max="10" step="0.5" value="3.0">
    </label>

    <label>Hablar PAR:
      <input id="talkPairSecs" type="number" min="1" max="15" step="0.5" value="4.5">
    </label>

    <label>Escuchar PAR:
      <input id="listenPairSecs" type="number" min="1" max="15" step="0.5" value="5.0">
    </label>
  </div>

  <div class="controls">
    <button id="perm">üé§ Permitir micr√≥fono</button>
    <button id="start" disabled>‚ñ∂Ô∏è Comenzar</button>
    <button id="stop" class="secondary" disabled>‚èπ Detener</button>
  </div>

  <div class="camShell">
    <video id="cam" playsinline muted autoplay></video>
    <div class="mouthGuide" aria-hidden="true"></div>
    <div class="overlayWord" id="wordOverlay">¬°Vamos!</div>

    <div class="camBtns">
      <button id="camOn" class="mini">üì∑ C√°mara</button>
      <button id="camOff" class="mini" disabled>üßØ Apagar</button>
    </div>
  </div>

  <div class="progressWrap" aria-label="Progreso">
    <div class="progressBar" id="progressBar"></div>
  </div>

  <audio id="audio" controls></audio>
  <div class="info" id="info">Si no suena autom√°tico, toca Play una vez. Ideal con aud√≠fonos.</div>
  <div class="small">Privacidad: no se guardan audios ni datos. Todo es temporal.</div>
</div>

<script>
/* PWA service worker */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(() => {});
  });
}

/* ===== LISTAS ===== */
const SERIES = ["pa","pe","pi","po","pu","aba","obo","ubu","ebe","ibi","bab","bob","bub","beb","bib","abababa","obobobo","ubububu","ebebebe","ibibibi"];

const P_B = [
  ["pasa","basa"],["pase","base"],["peso","beso"],["peca","beca"],["pasto","basto"],
  ["polo","bolo"],["supe","sube"],["pipa","piba"],["pata","bata"],["pala","bala"],
  ["puso","buzo"],["pasta","basta"],["tapa","taba"],["capo","cabo"],["topa","toba"]
];

const P_M = [
  ["pasa","masa"],["palo","malo"],["pesa","mesa"],["pel√≥n","mel√≥n"],["pipo","mimo"],
  ["poda","moda"],["pate","mat√©"],["pozo","mozo"],["pula","mula"],["pucho","mucho"],
  ["p√≠o","m√≠o"],["pisa","misa"],["dopa","doma"],["pudo","mudo"],["pata","mata"]
];

const VOCAB_B = [
  "bata","base","bate","bala","ba√±a",
  "bote","bota","bola","bot√≥n","botella",
  "buzo","buche","buque","bud√≠n","bueno",
  "beb√©","beso","beca","bello","bebida",
  "bicho","bien","bife","bigote","billete"
];

const CORTO = [
  ...SERIES.slice(0,10).map(a => ({type:"one", a})),
  ...P_B.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...P_M.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...VOCAB_B.slice(0,8).map(a => ({type:"one", a})),
];

function buildList(m){
  if(m==="series") return SERIES.map(a=>({type:"one",a}));
  if(m==="pvb") return P_B.map(([a,b])=>({type:"pair",a,b}));
  if(m==="pvm") return P_M.map(([a,b])=>({type:"pair",a,b}));
  if(m==="vocabB") return VOCAB_B.map(a=>({type:"one",a}));
  if(m==="corto") return CORTO;
  return [];
}

/* ===== UI ===== */
const infoEl = document.getElementById("info");
const wordOverlay = document.getElementById("wordOverlay");
const progressBar = document.getElementById("progressBar");
const audioEl = document.getElementById("audio");

const modeEl = document.getElementById("mode");
const talkSecsEl = document.getElementById("talkSecs");
const listenSecsEl = document.getElementById("listenSecs");
const talkPairSecsEl = document.getElementById("talkPairSecs");
const listenPairSecsEl = document.getElementById("listenPairSecs");

const btnPerm = document.getElementById("perm");
const btnStart = document.getElementById("start");
const btnStop  = document.getElementById("stop");

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function setProgress(p){ progressBar.style.width = Math.max(0, Math.min(100, p)) + "%"; }
async function runProgress(totalMs){
  const start = Date.now();
  while (Date.now() - start < totalMs) {
    if (!running || abortNow) return;
    setProgress(((Date.now() - start) / totalMs) * 100);
    await sleep(50);
  }
  setProgress(100);
}

/* Render pares ‚Äúpasa ‚Üí basa‚Äù con diferencias resaltadas */
function renderPair(a, b){
  const maxLen = Math.max(a.length, b.length);
  const A = a.padEnd(maxLen, " ");
  const B = b.padEnd(maxLen, " ");

  const aHtml = [...A].map((ch, i) => {
    const diff = A[i] !== B[i];
    const safe = ch === " " ? "&nbsp;" : ch;
    return diff ? `<span class="diff">${safe}</span>` : safe;
  }).join("");

  const bHtml = [...B].map((ch, i) => {
    const diff = A[i] !== B[i];
    const safe = ch === " " ? "&nbsp;" : ch;
    return diff ? `<span class="diff">${safe}</span>` : safe;
  }).join("");

  return `${aHtml}<span class="sep">‚Üí</span>${bHtml}`;
}

/* ===== Audio (WAV iPhone compatible) ===== */
let stream=null, audioCtx=null;
let running=false, abortNow=false;
let recSource=null, recProcessor=null;

function stopRecorderChain(){
  try { if (recProcessor) recProcessor.disconnect(); } catch {}
  try { if (recSource) recSource.disconnect(); } catch {}
  recProcessor = null; recSource = null;
}

async function pedirMicrofono(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({
      audio: { echoCancellation:true, noiseSuppression:true, autoGainControl:true }
    });
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    infoEl.textContent = "‚úÖ Micr√≥fono listo";
    btnStart.disabled = false;
  }catch(e){
    infoEl.textContent = "‚ö†Ô∏è No se pudo acceder al micr√≥fono. Revisa permisos en Safari.";
  }
}

function encodeWAV(samples, sr){
  const b=new ArrayBuffer(44+samples.length*2),v=new DataView(b);
  const ws=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));};
  ws(0,"RIFF"); v.setUint32(4,36+samples.length*2,true); ws(8,"WAVE"); ws(12,"fmt ");
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true);
  v.setUint32(24,sr,true); v.setUint32(28,sr*2,true); v.setUint16(32,2,true);
  v.setUint16(34,16,true); ws(36,"data"); v.setUint32(40,samples.length*2,true);
  let o=44;
  for(let i=0;i<samples.length;i++,o+=2){
    let s=Math.max(-1,Math.min(1,samples[i]));
    v.setInt16(o, s<0?s*0x8000:s*0x7fff, true);
  }
  return new Blob([v],{type:"audio/wav"});
}

async function grabarWav(ms){
  abortNow = false;

  recSource = audioCtx.createMediaStreamSource(stream);

  // filtro pasa-altos suave (reduce ruido grave)
  const hp = audioCtx.createBiquadFilter();
  hp.type = "highpass";
  hp.frequency.value = 120;

  recProcessor = audioCtx.createScriptProcessor(4096,1,1);

  let ch=[];
  recProcessor.onaudioprocess = e => {
    if (abortNow) return;
    ch.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };

  recSource.connect(hp);
  hp.connect(recProcessor);
  recProcessor.connect(audioCtx.destination); // requerido iOS

  for (let t = 0; t < ms; t += 50){
    if (abortNow || !running) break;
    await sleep(50);
  }

  stopRecorderChain();
  if (abortNow || !running) return null;

  let len=0; for(const c of ch) len+=c.length;
  const s=new Float32Array(len); let off=0;
  for(const c of ch){ s.set(c,off); off+=c.length; }
  return encodeWAV(s, audioCtx.sampleRate);
}

async function reproducir(blob){
  if (!blob) return;
  audioEl.src = URL.createObjectURL(blob);
  try { await audioEl.play(); }
  catch { infoEl.textContent = "Grabado ‚úÖ. Toca Play para escuchar."; }
}

/* ===== Loop ===== */
let idx=0, list=[];

async function ciclo(){
  running = true;
  abortNow = false;
  btnStop.disabled = false;
  btnStart.disabled = true;

  list = buildList(modeEl.value);
  idx = 0;
  setProgress(0);

  while(running){
    let talkSecs = Number(talkSecsEl.value || 2.5);
    let listenSecs = Number(listenSecsEl.value || 3.0);
    const item = list[idx % list.length];

    if(item.type === "pair"){
      talkSecs = Number(talkPairSecsEl.value || 4.5);
      listenSecs = Number(listenPairSecsEl.value || 5.0);
      wordOverlay.innerHTML = renderPair(item.a, item.b);
      infoEl.textContent = "Di izquierda ‚Üí derecha üôÇ";
    } else {
      wordOverlay.textContent = item.a;
      infoEl.textContent = "Di la palabra üôÇ";
    }

    // GRABAR
    infoEl.textContent = "üéôÔ∏è Grabando‚Ä¶";
    setProgress(0);
    const talkMs = Math.round(talkSecs * 1000);
    const progressTask = runProgress(talkMs);
    const wav = await grabarWav(talkMs);
    await progressTask;

    if (!running || abortNow) break;
    if (!wav) break;

    // ESCUCHAR
    infoEl.textContent = "‚ñ∂Ô∏è Escuchando tu voz";
    setProgress(0);
    await reproducir(wav);

    const listenMs = Math.round(listenSecs * 1000);
    await runProgress(listenMs);
    if (!running || abortNow) break;

    idx++;
    setProgress(0);
  }

  stopRecorderChain();
  setProgress(0);
  infoEl.textContent = "‚èπ Detenido";
  btnStop.disabled = true;
  btnStart.disabled = false;
}

/* Botones */
btnPerm.onclick = pedirMicrofono;

btnStart.onclick = async () => {
  if(!stream || !audioCtx){
    infoEl.textContent = "Primero permite el micr√≥fono.";
    return;
  }
  try{ await audioCtx.resume(); }catch{}
  ciclo();
};

btnStop.onclick = () => {
  running = false;
  abortNow = true;
  stopRecorderChain();
  setProgress(0);
  infoEl.textContent = "‚èπ Detenido";
};

/* C√°mara frontal */
const cam = document.getElementById("cam");
const camOn = document.getElementById("camOn");
const camOff = document.getElementById("camOff");
let camStream=null;

camOn.onclick = async () => {
  try{
    camStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"}, audio:false });
    cam.srcObject = camStream;
    camOn.disabled = true;
    camOff.disabled = false;
  } catch(e){
    infoEl.textContent = "‚ö†Ô∏è No se pudo encender la c√°mara. Revisa permisos.";
  }
};

camOff.onclick = () => {
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream=null;
    cam.srcObject=null;
  }
  camOn.disabled=false;
  camOff.disabled=true;
};
</script>
</body>
</html>








