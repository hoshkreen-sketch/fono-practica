<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pr√°ctica de pronunciaci√≥n</title>
<style>
  body { font-family: system-ui; background:#fff; margin:0; padding:16px; }
  h1 { font-size: 26px; margin: 0 0 8px; text-align:center; }
  .panel { max-width: 760px; margin: 0 auto; }

  .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0; }
  input, select { padding:8px 10px; border-radius: 12px; border:1px solid #ccc; text-align:center; font-size:15px; }

  .controls { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0; }
  button { font-size: 16px; padding: 10px 14px; border-radius: 14px; border: none; background:#111; color:#fff; }
  button.secondary { background:#666; }
  button:disabled { opacity: .5; }

  /* C√°mara + overlay */
  .camShell { position: relative; max-width: 520px; margin: 10px auto 0; }
  video { width:100%; display:block; border-radius:16px; border:1px solid #ddd; background:#000; }

  /* Palabra encima del video */
  .overlayWord {
    position:absolute; left:50%; top:10px; transform:translateX(-50%);
    background: rgba(255,255,255,.88);
    border:1px solid rgba(0,0,0,.12);
    border-radius: 14px;
    padding: 8px 14px;
    font-weight: 900;
    font-size: 40px;
    line-height: 1.05;
    text-align:center;
    max-width: 92%;
    word-break: break-word;
    backdrop-filter: blur(6px);
  }

  
  .sep { opacity: .55; padding: 0 10px; font-weight:700; }

  /* Resaltado de diferencias */
  .diff {
    text-decoration: underline;
    text-decoration-thickness: 3px;
    text-underline-offset: 4px;
    padding: 0 2px;
    border-radius: 6px;
    background: rgba(0,0,0,.06);
  }

  /* Botones peque√±os sobre la c√°mara */
  .camBtns {
    position:absolute; right:10px; bottom:10px;
    display:flex; gap:8px;
  }
  .mini {
    font-size: 13px !important;
    padding: 8px 10px !important;
    border-radius: 12px !important;
  }

  /* Barra de progreso */
  .progressWrap {
    max-width: 520px;
    margin: 12px auto 0;
    border: 1px solid #e5e5e5;
    border-radius: 999px;
    overflow: hidden;
    height: 12px;
    background: #f2f2f2;
  }
  .progressBar {
    height: 100%;
    width: 0%;
    background: #111;
    transition: width .08s linear;
  }

  audio { width:100%; margin-top:12px; }
  .info { text-align:center; color:#666; margin-top:10px; font-size:14px; }
</style>
</head>

<body>
<div class="panel">

<h1>Pr√°ctica de pronunciaci√≥n</h1>

<div class="row">
  <label>
    Ejercicio:
    <select id="mode">
      <option value="series">Series (pa/pe/pi‚Ä¶ + aba/obo‚Ä¶)</option>
      <option value="pvb">Discriminaci√≥n P / B</option>
      <option value="pvm">Discriminaci√≥n P / M</option>
      <option value="vocabB">Vocabulario con B</option>
      <option value="corto">Sesi√≥n corta suave</option>
    </select>
  </label>

  <label>Hablar:
    <input id="talkSecs" type="number" min="1" max="10" step="0.5" value="2.5">
  </label>

  <label>Escuchar:
    <input id="listenSecs" type="number" min="1" max="10" step="0.5" value="3.0">
  </label>

  <label>Hablar PAR:
    <input id="talkPairSecs" type="number" min="1" max="15" step="0.5" value="4.5">
  </label>

  <label>Escuchar PAR:
    <input id="listenPairSecs" type="number" min="1" max="15" step="0.5" value="5.0">
  </label>
</div>

<div class="controls">
  <button id="perm">Permitir micr√≥fono</button>
  <button id="start" disabled>Comenzar</button>
  <button id="stop" class="secondary" disabled>Detener</button>
</div>

<!-- C√°mara con palabra encima -->
<div class="camShell">
  <video id="cam" playsinline muted autoplay></video>

  <div class="overlayWord" id="wordOverlay">Presiona comenzar</div>

  <div class="camBtns">
    <button id="camOn" class="secondary mini">C√°mara</button>
    <button id="camOff" class="secondary mini" disabled>Apagar</button>
  </div>
</div>

<div class="progressWrap" aria-label="Progreso">
  <div class="progressBar" id="progressBar"></div>
</div>

<audio id="audio" controls></audio>
<div class="info" id="info">Tip: si no suena autom√°tico, toca Play una vez. Mejor con aud√≠fonos.</div>

<script>
/* ===== LISTAS ===== */
const SERIES = ["pa","pe","pi","po","pu","aba","obo","ubu","ebe","ibi","bab","bob","bub","beb","bib","abababa","obobobo","ubububu","ebebebe","ibibibi"];

const P_B = [
  ["pasa","basa"],["pase","base"],["peso","beso"],["peca","beca"],["pasto","basto"],
  ["polo","bolo"],["supe","sube"],["pipa","piba"],["pata","bata"],["pala","bala"],
  ["puso","buzo"],["pasta","basta"],["tapa","taba"],["capo","cabo"],["topa","toba"]
];

const P_M = [
  ["pasa","masa"],["palo","malo"],["pesa","mesa"],["pel√≥n","mel√≥n"],["pipo","mimo"],
  ["poda","moda"],["pate","mat√©"],["pozo","mozo"],["pula","mula"],["pucho","mucho"],
  ["p√≠o","m√≠o"],["pisa","misa"],["dopa","doma"],["pudo","mudo"],["pata","mata"]
];

const VOCAB_B = [
  "bata","base","bate","bala","ba√±a",
  "bote","bota","bola","bot√≥n","botella",
  "buzo","buche","buque","bud√≠n","bueno",
  "beb√©","beso","beca","bello","bebida",
  "bicho","bien","bife","bigote","billete"
];

const CORTO = [
  ...SERIES.slice(0,10).map(a => ({type:"one", a})),
  ...P_B.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...P_M.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...VOCAB_B.slice(0,8).map(a => ({type:"one", a})),
];

function buildList(m){
  if(m==="series") return SERIES.map(a=>({type:"one",a}));
  if(m==="pvb") return P_B.map(([a,b])=>({type:"pair",a,b}));
  if(m==="pvm") return P_M.map(([a,b])=>({type:"pair",a,b}));
  if(m==="vocabB") return VOCAB_B.map(a=>({type:"one",a}));
  if(m==="corto") return CORTO;
  return [];
}

/* ===== UI refs ===== */
const infoEl = document.getElementById("info");
const wordOverlay = document.getElementById("wordOverlay");
const countdownEl = document.getElementById("countdown");
const progressBar = document.getElementById("progressBar");
const audioEl = document.getElementById("audio");

const modeEl = document.getElementById("mode");
const talkSecsEl = document.getElementById("talkSecs");
const listenSecsEl = document.getElementById("listenSecs");
const talkPairSecsEl = document.getElementById("talkPairSecs");
const listenPairSecsEl = document.getElementById("listenPairSecs");

const btnPerm = document.getElementById("perm");
const btnStart = document.getElementById("start");
const btnStop  = document.getElementById("stop");

/* ===== Helpers ===== */
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

/* Resalta TODAS las letras diferentes y pone flecha */
function renderPair(a, b){
  const maxLen = Math.max(a.length, b.length);
  const A = a.padEnd(maxLen, " ");
  const B = b.padEnd(maxLen, " ");

  const aHtml = [...A].map((ch, i) => {
    const diff = A[i] !== B[i];
    const safe = ch === " " ? "&nbsp;" : ch;
    return diff ? `<span class="diff">${safe}</span>` : safe;
  }).join("");

  const bHtml = [...B].map((ch, i) => {
    const diff = A[i] !== B[i];
    const safe = ch === " " ? "&nbsp;" : ch;
    return diff ? `<span class="diff">${safe}</span>` : safe;
  }).join("");

  return `${aHtml}<span class="sep">‚Üí</span>${bHtml}`;
}

function setProgress(pct){
  const clamped = Math.max(0, Math.min(100, pct));
  progressBar.style.width = clamped + "%";
}

async function runProgress(totalMs, label){
  // Barra suave que se puede cortar
  const start = Date.now();
  while (Date.now() - start < totalMs) {
    if (!running || abortNow) return;
    const pct = ((Date.now() - start) / totalMs) * 100;
    setProgress(pct);
    await sleep(50);
  }
  setProgress(100);
}


/* ===== Audio (WAV iPhone compatible) ===== */
let stream=null, audioCtx=null;

// Para detener r√°pido:
let running=false;
let abortNow=false;

// Referencias para cortar el procesamiento inmediatamente
let recSource=null;
let recProcessor=null;

async function pedirMicrofono(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    infoEl.textContent = "Micr√≥fono listo ‚úÖ";
    btnStart.disabled = false;
  }catch(e){
    infoEl.textContent = "No se pudo acceder al micr√≥fono. Revisa permisos en Safari.";
  }
}

function encodeWAV(samples, sr){
  const b=new ArrayBuffer(44+samples.length*2),v=new DataView(b);
  const ws=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));};
  ws(0,"RIFF"); v.setUint32(4,36+samples.length*2,true); ws(8,"WAVE"); ws(12,"fmt ");
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true);
  v.setUint32(24,sr,true); v.setUint32(28,sr*2,true); v.setUint16(32,2,true);
  v.setUint16(34,16,true); ws(36,"data"); v.setUint32(40,samples.length*2,true);
  let o=44;
  for(let i=0;i<samples.length;i++,o+=2){
    let s=Math.max(-1,Math.min(1,samples[i]));
    v.setInt16(o, s<0?s*0x8000:s*0x7fff, true);
  }
  return new Blob([v],{type:"audio/wav"});
}

function stopRecorderChain(){
  try { if (recProcessor) recProcessor.disconnect(); } catch(e){}
  try { if (recSource) recSource.disconnect(); } catch(e){}
  recProcessor = null;
  recSource = null;
}

async function grabarWav(ms){
  abortNow = false;

  recSource = audioCtx.createMediaStreamSource(stream);
  recProcessor = audioCtx.createScriptProcessor(4096,1,1);

  let ch=[];
  recProcessor.onaudioprocess = e => {
    if (abortNow) return;
    ch.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };

  recSource.connect(recProcessor);
  recProcessor.connect(audioCtx.destination); // requerido en iOS

  // Espera cortable
  for (let t = 0; t < ms; t += 50){
    if (abortNow || !running) break;
    await sleep(50);
  }

  stopRecorderChain();

  // si se abort√≥, devuelve blob vac√≠o para que el loop corte
  if (abortNow || !running) return null;

  let len=0; for(const c of ch) len+=c.length;
  const s=new Float32Array(len); let off=0;
  for(const c of ch){ s.set(c,off); off+=c.length; }
  return encodeWAV(s, audioCtx.sampleRate);
}

async function reproducir(blob){
  if (!blob) return;
  audioEl.src = URL.createObjectURL(blob);
  try { await audioEl.play(); }
  catch(e){ infoEl.textContent = "Grabado ‚úÖ. Toca Play para escuchar."; }
}

/* ===== Loop principal ===== */
let idx=0, list=[];

async function ciclo(){
  running = true;
  abortNow = false;
  btnStop.disabled = false;
  btnStart.disabled = true;

  list = buildList(modeEl.value);
  idx = 0;
  setProgress(0);

  while(running){
    let talkSecs = Number(talkSecsEl.value || 2.5);
    let listenSecs = Number(listenSecsEl.value || 3.0);
    const item = list[idx % list.length];

    if(item.type === "pair"){
      talkSecs = Number(talkPairSecsEl.value || 4.5);
      listenSecs = Number(listenPairSecsEl.value || 5.0);
      wordOverlay.innerHTML = renderPair(item.a, item.b); // SOLO juntas
      infoEl.textContent = "Prep√°rate‚Ä¶ luego di izquierda y derecha‚Ä¶";
    } else {
      wordOverlay.textContent = item.a;
      infoEl.textContent = "Prep√°rate‚Ä¶";
    }

    // grabar con progreso
    infoEl.textContent = "Grabando‚Ä¶ üéôÔ∏è";
    setProgress(0);
    const talkMs = Math.round(talkSecs * 1000);

    // correr barra en paralelo
    const progressTask = runProgress(talkMs, "grabando");
    const wav = await grabarWav(talkMs);
    await progressTask;

    if (!running || abortNow) break;
    if (!wav) break;

    // reproducir
    infoEl.textContent = "Escuchando tu voz ‚ñ∂Ô∏è";
    setProgress(0);
    await reproducir(wav);

    // progreso de escucha
    const listenMs = Math.round(listenSecs * 1000);
    await runProgress(listenMs, "escuchando");
    if (!running || abortNow) break;

    idx++;
    setProgress(0);
  }

  // salida limpia
  stopRecorderChain();
  setProgress(0);
  infoEl.textContent = "Detenido.";
  btnStop.disabled = true;
  btnStart.disabled = false;
}

/* Botones */
btnPerm.onclick = pedirMicrofono;

btnStart.onclick = async () => {
  if(!stream || !audioCtx){
    infoEl.textContent = "Primero pulsa 'Permitir micr√≥fono'.";
    return;
  }
  try{ await audioCtx.resume(); }catch(e){}
  ciclo();
};

btnStop.onclick = () => {
  // ‚úÖ detener r√°pido
  running = false;
  abortNow = true;
  stopRecorderChain();
  setProgress(0);
  infoEl.textContent = "Deteniendo‚Ä¶";
};

/* ===== C√°mara frontal ===== */
const cam = document.getElementById("cam");
const camOn = document.getElementById("camOn");
const camOff = document.getElementById("camOff");
let camStream=null;

camOn.onclick = async () => {
  try{
    camStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"}, audio:false });
    cam.srcObject = camStream;
    camOn.disabled = true;
    camOff.disabled = false;
  } catch(e){
    infoEl.textContent = "No se pudo encender la c√°mara. Revisa permisos.";
  }
};

camOff.onclick = () => {
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream=null;
    cam.srcObject=null;
  }
  camOn.disabled=false;
  camOff.disabled=true;
};
</script>

</div>
</body>
</html>








