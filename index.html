<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Práctica de pronunciación</title>
<style>
  body { font-family: system-ui; background:#fff; margin:0; padding:20px; }
  h1 { font-size: 32px; margin: 0 0 10px; }
  .big { font-size: 64px; font-weight: 800; text-align:center; margin: 24px 0 14px; }
  .controls { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin: 10px 0; }
  button { font-size: 18px; padding: 14px 18px; border-radius: 16px; border: none; background:#111; color:#fff; }
  button.secondary { background:#666; }
  button:disabled { opacity: .5; }
  audio { width:100%; margin-top:14px; }
  .info { text-align:center; color:#666; margin-top:10px; }
  .row { display:flex; gap:12px; justify-content:center; flex-wrap:wrap; margin-top: 12px; }
  input, select { padding:10px 12px; border-radius: 12px; border:1px solid #ccc; text-align:center; font-size:16px; }
  .panel { max-width: 680px; margin: 0 auto; }
  .camWrap { text-align:center; margin-top:16px; }
  video { width:100%; max-width:520px; display:block; margin:0 auto; border-radius:16px; border:1px solid #ddd; background:#000; }
</style>
</head>
<body>
<div class="panel">

<h1>Práctica de pronunciación</h1>

<div class="row">
  <label>
    Ejercicio:
    <select id="mode">
      <option value="series">Series (pa/pe/pi… + aba/obo…)</option>
      <option value="pvb">Discriminación P / B (pares)</option>
      <option value="pvm">Discriminación P / M (pares)</option>
      <option value="vocabB">Vocabulario con B</option>
      <option value="corto">Sesión corta suave (recomendada)</option>
    </select>
  </label>

  <label>Hablar (seg):
    <input id="talkSecs" type="number" min="1" max="10" step="0.5" value="2.5">
  </label>

  <label>Escuchar (seg):
    <input id="listenSecs" type="number" min="1" max="10" step="0.5" value="3.0">
  </label>
</div>

<div class="big" id="word">Presiona comenzar</div>

<div class="controls">
  <button id="perm">Permitir micrófono</button>
  <button id="start" disabled>Comenzar</button>
  <button id="stop" class="secondary" disabled>Detener</button>
</div>

<div class="camWrap">
  <div class="controls" style="margin-bottom:10px;">
    <button id="camOn" class="secondary">Activar cámara</button>
    <button id="camOff" class="secondary" disabled>Apagar cámara</button>
  </div>

  <video id="cam" playsinline muted autoplay></video>
  <div class="info" id="camInfo">Cámara apagada.</div>
</div>

<audio id="audio" controls></audio>
<div class="info" id="info">
  Consejo: usa audífonos. Si el iPhone está en silencio (switch), puede no sonar.
</div>

<script>
/* =========================
   LISTAS (desde tus imágenes)
========================= */

// Series articulatorias
const SERIES = [
  "pa","pe","pi","po","pu",
  "aba","obo","ubu","ebe","ibi",
  "aba","abo","abu","abe","abi",
  "oba","obo","obu","obe","obi",
  "uba","ubo","ubu","ube","ubi",
  "eba","ebo","ebu","ebe","ebi",
  "iba","ibo","ibu","ibe","ibi",
  "bab","bob","bub","beb","bib",
  "abababa","obobobo","ubububu","ebebebe","ibibibi",
  "abobeba","obibabi","ubebabo","ebibobu","ibubibe",
];

// P vs B (pares)
const P_B = [
  ["pasa","basa"], ["pase","base"], ["peso","beso"], ["peca","beca"], ["pasto","basto"],
  ["polo","bolo"], ["supe","sube"], ["pipa","piba"], ["pata","bata"], ["pala","bala"],
  ["puso","buzo"], ["pasta","basta"], ["tapa","taba"], ["capo","cabo"], ["topa","toba"]
];

// P vs M (pares)
const P_M = [
  ["pasa","masa"], ["palo","malo"], ["pesa","mesa"], ["pelón","melón"], ["pipo","mimo"],
  ["poda","moda"], ["pate","maté"], ["pozo","mozo"], ["pula","mula"], ["pucho","mucho"],
  ["pío","mío"], ["pisa","misa"], ["dopa","doma"], ["pudo","mudo"], ["pata","mata"]
];

// Vocabulario con B
const VOCAB_B = [
  "bata","base","bate","bala","baña",
  "bote","bota","bola","botón","botella",
  "buzo","buche","buque","budín","bueno",
  "bebé","beso","beca","bello","bebida",
  "bicho","bien","bife","bigote","billete"
];

// Sesión corta suave: 10 series + 5 P/B + 5 P/M + 10 vocab B
const CORTO = [
  ...SERIES.slice(0,10).map(a => ({type:"one", a})),
  ...P_B.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...P_M.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...VOCAB_B.slice(0,10).map(a => ({type:"one", a})),
];

function buildList(mode){
  if (mode === "series") return SERIES.map(a => ({type:"one", a}));
  if (mode === "pvb") return P_B.map(([a,b]) => ({type:"pair", a, b}));
  if (mode === "pvm") return P_M.map(([a,b]) => ({type:"pair", a, b}));
  if (mode === "vocabB") return VOCAB_B.map(a => ({type:"one", a}));
  if (mode === "corto") return CORTO;
  return [];
}

/* =========================
   WAV recorder (Web Audio) – iPhone compatible
========================= */
const wordEl = document.getElementById("word");
const infoEl = document.getElementById("info");
const audioEl = document.getElementById("audio");
const modeEl = document.getElementById("mode");
const talkSecsEl = document.getElementById("talkSecs");
const listenSecsEl = document.getElementById("listenSecs");

const btnPerm = document.getElementById("perm");
const btnStart = document.getElementById("start");
const btnStop  = document.getElementById("stop");

let stream = null;
let audioCtx = null;
let running = false;
let idx = 0;
let list = [];

function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function pedirMicrofono(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    infoEl.textContent = "Micrófono listo ✅";
    btnStart.disabled = false;
  } catch(e){
    infoEl.textContent = "No se pudo acceder al micrófono. Revisa permisos en Safari.";
  }
}

function floatTo16BitPCM(output, offset, input){
  for (let i=0; i<input.length; i++, offset+=2){
    let s = Math.max(-1, Math.min(1, input[i]));
    output.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);
  }
}

function writeString(view, offset, string){
  for (let i=0; i<string.length; i++) view.setUint8(offset+i, string.charCodeAt(i));
}

function encodeWAV(samples, sampleRate){
  const buffer = new ArrayBuffer(44 + samples.length*2);
  const view = new DataView(buffer);

  writeString(view, 0, "RIFF");
  view.setUint32(4, 36 + samples.length*2, true);
  writeString(view, 8, "WAVE");
  writeString(view, 12, "fmt ");
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(view, 36, "data");
  view.setUint32(40, samples.length*2, true);

  floatTo16BitPCM(view, 44, samples);
  return new Blob([view], { type:"audio/wav" });
}

async function grabarWav(duracionMs){
  const source = audioCtx.createMediaStreamSource(stream);
  const processor = audioCtx.createScriptProcessor(4096, 1, 1);

  let chunks = [];
  processor.onaudioprocess = (e) => {
    const input = e.inputBuffer.getChannelData(0);
    chunks.push(new Float32Array(input));
  };

  source.connect(processor);
  processor.connect(audioCtx.destination); // requerido para que procese en iOS

  await sleep(duracionMs);

  processor.disconnect();
  source.disconnect();

  let length = 0;
  for (const c of chunks) length += c.length;
  const samples = new Float32Array(length);
  let offset = 0;
  for (const c of chunks){ samples.set(c, offset); offset += c.length; }

  return encodeWAV(samples, audioCtx.sampleRate);
}

async function reproducirBlob(blob){
  const url = URL.createObjectURL(blob);
  audioEl.src = url;
  try{
    await audioEl.play();
  } catch(e){
    infoEl.textContent = "Grabado ✅. Toca Play para escuchar (iPhone bloqueó autoplay).";
  }
}

/* =========================
   Loop principal
========================= */
async function ciclo(){
  running = true;
  btnStop.disabled = false;
  btnStart.disabled = true;

  list = buildList(modeEl.value);
  idx = 0;

  while(running){
    const talkSecs = Number(talkSecsEl.value || 2.5);
    const listenSecs = Number(listenSecsEl.value || 3.0);

    const item = list[idx % list.length];

    // Mostrar qué repetir
    if (item.type === "pair"){
      wordEl.textContent = `${item.a} / ${item.b}`;
      infoEl.textContent = "Di ambas (primero la izquierda, luego la derecha)…";
    } else {
      wordEl.textContent = item.a;
      infoEl.textContent = "Di la palabra ahora…";
    }

    // Grabar tu voz
    const wav = await grabarWav(talkSecs * 1000);

    // Reproducir al instante
    infoEl.textContent = "Escuchando tu voz ▶️";
    await reproducirBlob(wav);

    await sleep(listenSecs * 1000);
    idx++;
  }

  infoEl.textContent = "Detenido.";
  btnStop.disabled = true;
  btnStart.disabled = false;
}

btnPerm.onclick = pedirMicrofono;

btnStart.onclick = async () => {
  if (!stream || !audioCtx){
    infoEl.textContent = "Primero pulsa 'Permitir micrófono'.";
    return;
  }
  try { await audioCtx.resume(); } catch(e){}
  ciclo();
};

btnStop.onclick = () => { running = false; };

/* =========================
   Cámara frontal (selfie)
========================= */
const camVideo = document.getElementById("cam");
const camInfo = document.getElementById("camInfo");
const camOn = document.getElementById("camOn");
const camOff = document.getElementById("camOff");
let camStream = null;

async function encenderCamara(){
  try{
    camStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" },
      audio: false
    });
    camVideo.srcObject = camStream;
    camInfo.textContent = "Cámara encendida ✅ (mira el movimiento de tu boca)";
    camOn.disabled = true;
    camOff.disabled = false;
  } catch(e){
    camInfo.textContent = "No se pudo encender la cámara. Revisa permisos de Safari.";
  }
}

function apagarCamara(){
  if (!camStream) return;
  camStream.getTracks().forEach(t => t.stop());
  camStream = null;
  camVideo.srcObject = null;
  camInfo.textContent = "Cámara apagada.";
  camOn.disabled = false;
  camOff.disabled = true;
}

camOn.addEventListener("click", encenderCamara);
camOff.addEventListener("click", apagarCamara);
</script>

</div>
</body>
</html>
