<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#111111">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<title>Fono Pr√°ctica</title>
<style>
  body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:#fff; margin:0; padding:16px; }
  h1 { font-size: 22px; margin: 0 0 8px; text-align:center; }
  .panel { max-width: 820px; margin: 0 auto; }

  .row { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0; align-items:center; }
  input, select {
    padding:8px 10px; border-radius: 12px; border:1px solid #ccc;
    text-align:center; font-size:15px; background:#fff;
  }

  .controls { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; margin: 10px 0; }
  button { font-size: 15px; padding: 10px 14px; border-radius: 14px; border: none; background:#111; color:#fff; }
  button.secondary { background:#666; }
  button.ghost { background:#fff; color:#111; border:1px solid #ccc; }
  button:disabled { opacity: .5; }

  .camShell { position: relative; max-width: 520px; margin: 10px auto 0; }
  video {
    width:100%; display:block; border-radius:16px; border:1px solid #ddd; background:#000;
    transform: scaleX(-1); /* ‚úÖ espejo */
  }

  .overlayWord {
    position:absolute; left:50%; top:10px; transform:translateX(-50%);
    background: rgba(255,255,255,.88);
    border:1px solid rgba(0,0,0,.12);
    border-radius: 14px;
    padding: 8px 14px;
    font-weight: 900;
    font-size: 38px;
    line-height: 1.05;
    text-align:center;
    max-width: 92%;
    word-break: break-word;
    backdrop-filter: blur(6px);
  }

  .mouthGuide{
    position:absolute;
    left:50%;
    top:60%;
    transform: translate(-50%, -50%);
    width: 62%;
    height: 32%;
    border: 3px solid rgba(255,255,255,.85);
    border-radius: 18px;
    box-shadow: 0 0 0 2px rgba(0,0,0,.20), 0 10px 30px rgba(0,0,0,.25);
    pointer-events:none;
  }

  .camBtns { position:absolute; right:10px; bottom:10px; display:flex; gap:8px; }
  .mini { font-size: 13px !important; padding: 8px 10px !important; border-radius: 12px !important; }

  .sep { opacity: .55; padding: 0 10px; font-weight:700; }
  .diff {
    text-decoration: underline;
    text-decoration-thickness: 3px;
    text-underline-offset: 4px;
    padding: 0 2px;
    border-radius: 6px;
    background: rgba(0,0,0,.06);
  }

  .progressWrap {
    max-width: 520px;
    margin: 12px auto 0;
    border: 1px solid #e5e5e5;
    border-radius: 999px;
    overflow: hidden;
    height: 12px;
    background: #f2f2f2;
  }
  .progressBar { height: 100%; width: 0%; background: #111; transition: width .08s linear; }

  audio { width:100%; margin-top:12px; }
  .info { text-align:center; color:#666; margin-top:10px; font-size:14px; }
  .small { font-size: 12px; color:#666; text-align:center; margin-top: 8px; }

  .card {
    max-width: 820px; margin: 12px auto; border:1px solid #eee; border-radius: 16px; padding: 10px;
    background:#fafafa;
  }
  .card h2 { font-size: 16px; margin: 0 0 8px; }
</style>
</head>

<body>
<div class="panel">

<h1>Fono Pr√°ctica (PWA)</h1>

<div class="card">
  <h2>Paciente (opcional)</h2>
  <div class="row">
    <label>C√≥digo/Nombre:
      <input id="patientCode" placeholder="Ej: Roxana / AB12" style="width:180px">
    </label>
    <button id="savePatient" class="ghost">Guardar</button>
    <button id="clearPatient" class="ghost">Borrar</button>
  </div>
  <div class="small">Se guarda solo en el tel√©fono (privacidad). La fono puede pedir que exportes la sesi√≥n al final.</div>
</div>

<div class="row">
  <label>
    Ejercicio:
    <select id="mode">
      <option value="series">Series (pa/pe/pi‚Ä¶ + aba/obo‚Ä¶)</option>
      <option value="pvb">Discriminaci√≥n P / B</option>
      <option value="pvm">Discriminaci√≥n P / M</option>
      <option value="vocabB">Vocabulario con B</option>
      <option value="corto">Sesi√≥n corta suave</option>
    </select>
  </label>

  <label>Hablar:
    <input id="talkSecs" type="number" min="1" max="10" step="0.5" value="2.5">
  </label>

  <label>Escuchar:
    <input id="listenSecs" type="number" min="1" max="10" step="0.5" value="3.0">
  </label>

  <label>Hablar PAR:
    <input id="talkPairSecs" type="number" min="1" max="15" step="0.5" value="4.5">
  </label>

  <label>Escuchar PAR:
    <input id="listenPairSecs" type="number" min="1" max="15" step="0.5" value="5.0">
  </label>
</div>

<div class="controls">
  <button id="perm">Permitir micr√≥fono</button>
  <button id="start" disabled>Comenzar</button>
  <button id="stop" class="secondary" disabled>Detener</button>
  <button id="export" class="ghost">Exportar sesi√≥n</button>
  <button id="resetSession" class="ghost">Reiniciar sesi√≥n</button>
</div>

<div class="camShell">
  <video id="cam" playsinline muted autoplay></video>
  <div class="mouthGuide" aria-hidden="true"></div>
  <div class="overlayWord" id="wordOverlay">Presiona comenzar</div>

  <div class="camBtns">
    <button id="camOn" class="secondary mini">C√°mara</button>
    <button id="camOff" class="secondary mini" disabled>Apagar</button>
  </div>
</div>

<div class="progressWrap" aria-label="Progreso">
  <div class="progressBar" id="progressBar"></div>
</div>

<audio id="audio" controls></audio>
<div class="info" id="info">Tip: si no suena autom√°tico, toca Play una vez. Mejor con aud√≠fonos.</div>

<script>
/* ===== PWA service worker ===== */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./service-worker.js").catch(() => {});
  });
}

/* ===== LISTAS (pueden crecer) ===== */
const SERIES = ["pa","pe","pi","po","pu","aba","obo","ubu","ebe","ibi","bab","bob","bub","beb","bib","abababa","obobobo","ubububu","ebebebe","ibibibi"];

const P_B = [
  ["pasa","basa"],["pase","base"],["peso","beso"],["peca","beca"],["pasto","basto"],
  ["polo","bolo"],["supe","sube"],["pipa","piba"],["pata","bata"],["pala","bala"],
  ["puso","buzo"],["pasta","basta"],["tapa","taba"],["capo","cabo"],["topa","toba"]
];

const P_M = [
  ["pasa","masa"],["palo","malo"],["pesa","mesa"],["pel√≥n","mel√≥n"],["pipo","mimo"],
  ["poda","moda"],["pate","mat√©"],["pozo","mozo"],["pula","mula"],["pucho","mucho"],
  ["p√≠o","m√≠o"],["pisa","misa"],["dopa","doma"],["pudo","mudo"],["pata","mata"]
];

const VOCAB_B = [
  "bata","base","bate","bala","ba√±a",
  "bote","bota","bola","bot√≥n","botella",
  "buzo","buche","buque","bud√≠n","bueno",
  "beb√©","beso","beca","bello","bebida",
  "bicho","bien","bife","bigote","billete"
];

const CORTO = [
  ...SERIES.slice(0,10).map(a => ({type:"one", a})),
  ...P_B.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...P_M.slice(0,5).map(([a,b]) => ({type:"pair", a, b})),
  ...VOCAB_B.slice(0,8).map(a => ({type:"one", a})),
];

function buildList(m){
  if(m==="series") return SERIES.map(a=>({type:"one",a}));
  if(m==="pvb") return P_B.map(([a,b])=>({type:"pair",a,b}));
  if(m==="pvm") return P_M.map(([a,b])=>({type:"pair",a,b}));
  if(m==="vocabB") return VOCAB_B.map(a=>({type:"one",a}));
  if(m==="corto") return CORTO;
  return [];
}

/* ===== UI ===== */
const infoEl = document.getElementById("info");
const wordOverlay = document.getElementById("wordOverlay");
const progressBar = document.getElementById("progressBar");
const audioEl = document.getElementById("audio");

const modeEl = document.getElementById("mode");
const talkSecsEl = document.getElementById("talkSecs");
const listenSecsEl = document.getElementById("listenSecs");
const talkPairSecsEl = document.getElementById("talkPairSecs");
const listenPairSecsEl = document.getElementById("listenPairSecs");

const btnPerm = document.getElementById("perm");
const btnStart = document.getElementById("start");
const btnStop  = document.getElementById("stop");
const btnExport = document.getElementById("export");
const btnResetSession = document.getElementById("resetSession");

const patientCodeEl = document.getElementById("patientCode");
const btnSavePatient = document.getElementById("savePatient");
const btnClearPatient = document.getElementById("clearPatient");

function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function setProgress(pct){
  progressBar.style.width = Math.max(0, Math.min(100, pct)) + "%";
}
async function runProgress(totalMs){
  const start = Date.now();
  while (Date.now() - start < totalMs) {
    if (!running || abortNow) return;
    setProgress(((Date.now() - start) / totalMs) * 100);
    await sleep(50);
  }
  setProgress(100);
}

/* ===== Render pares: ‚Äúpasa ‚Üí basa‚Äù con diferencias resaltadas ===== */
function renderPair(a, b){
  const maxLen = Math.max(a.length, b.length);
  const A = a.padEnd(maxLen, " ");
  const B = b.padEnd(maxLen, " ");

  const aHtml = [...A].map((ch, i) => {
    const diff = A[i] !== B[i];
    const safe = ch === " " ? "&nbsp;" : ch;
    return diff ? `<span class="diff">${safe}</span>` : safe;
  }).join("");

  const bHtml = [...B].map((ch, i) => {
    const diff = A[i] !== B[i];
    const safe = ch === " " ? "&nbsp;" : ch;
    return diff ? `<span class="diff">${safe}</span>` : safe;
  }).join("");

  return `${aHtml}<span class="sep">‚Üí</span>${bHtml}`;
}

/* ===== Sesi√≥n (se guarda local) ===== */
const LS_PATIENT = "fono_patient_code_v1";
const LS_SESSION = "fono_session_v1";

let session = {
  version: 1,
  startedAt: new Date().toISOString(),
  patientCode: "",
  events: [] // {ts, mode, itemText, talkSecs, listenSecs}
};

function loadPatient(){
  const v = localStorage.getItem(LS_PATIENT) || "";
  patientCodeEl.value = v;
  session.patientCode = v;
}
function savePatient(){
  const v = (patientCodeEl.value || "").trim();
  localStorage.setItem(LS_PATIENT, v);
  session.patientCode = v;
  infoEl.textContent = "Paciente guardado ‚úÖ";
}
function clearPatient(){
  localStorage.removeItem(LS_PATIENT);
  patientCodeEl.value = "";
  session.patientCode = "";
  infoEl.textContent = "Paciente borrado.";
}

function saveSession(){
  localStorage.setItem(LS_SESSION, JSON.stringify(session));
}
function loadSession(){
  const raw = localStorage.getItem(LS_SESSION);
  if (!raw) return;
  try {
    const s = JSON.parse(raw);
    if (s && s.version === 1) session = s;
  } catch {}
}
function resetSession(){
  session = { version: 1, startedAt: new Date().toISOString(), patientCode: (patientCodeEl.value||"").trim(), events: [] };
  saveSession();
  infoEl.textContent = "Sesi√≥n reiniciada.";
}

function exportSession(){
  // Exporta como JSON (la fono lo puede revisar o importar luego)
  const blob = new Blob([JSON.stringify(session, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  const code = (session.patientCode || "paciente").replace(/[^\w-]+/g, "_");
  a.download = `fono_sesion_${code}_${new Date().toISOString().slice(0,10)}.json`;
  a.click();
}

/* ===== Audio (WAV iPhone compatible) ===== */
let stream=null, audioCtx=null;
let running=false, abortNow=false;
let recSource=null, recProcessor=null;

function stopRecorderChain(){
  try { if (recProcessor) recProcessor.disconnect(); } catch {}
  try { if (recSource) recSource.disconnect(); } catch {}
  recProcessor = null;
  recSource = null;
}

async function pedirMicrofono(){
  try{
    stream = await navigator.mediaDevices.getUserMedia({audio:true});
    audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    infoEl.textContent = "Micr√≥fono listo ‚úÖ";
    btnStart.disabled = false;
  }catch(e){
    infoEl.textContent = "No se pudo acceder al micr√≥fono. Revisa permisos en Safari.";
  }
}

function encodeWAV(samples, sr){
  const b=new ArrayBuffer(44+samples.length*2),v=new DataView(b);
  const ws=(o,s)=>{for(let i=0;i<s.length;i++)v.setUint8(o+i,s.charCodeAt(i));};
  ws(0,"RIFF"); v.setUint32(4,36+samples.length*2,true); ws(8,"WAVE"); ws(12,"fmt ");
  v.setUint32(16,16,true); v.setUint16(20,1,true); v.setUint16(22,1,true);
  v.setUint32(24,sr,true); v.setUint32(28,sr*2,true); v.setUint16(32,2,true);
  v.setUint16(34,16,true); ws(36,"data"); v.setUint32(40,samples.length*2,true);
  let o=44;
  for(let i=0;i<samples.length;i++,o+=2){
    let s=Math.max(-1,Math.min(1,samples[i]));
    v.setInt16(o, s<0?s*0x8000:s*0x7fff, true);
  }
  return new Blob([v],{type:"audio/wav"});
}

async function grabarWav(ms){
  abortNow = false;

  recSource = audioCtx.createMediaStreamSource(stream);
  recProcessor = audioCtx.createScriptProcessor(4096,1,1);

  let ch=[];
  recProcessor.onaudioprocess = e => {
    if (abortNow) return;
    ch.push(new Float32Array(e.inputBuffer.getChannelData(0)));
  };

  recSource.connect(recProcessor);
  recProcessor.connect(audioCtx.destination); // iOS requirement

  for (let t = 0; t < ms; t += 50){
    if (abortNow || !running) break;
    await sleep(50);
  }

  stopRecorderChain();

  if (abortNow || !running) return null;

  let len=0; for(const c of ch) len+=c.length;
  const s=new Float32Array(len); let off=0;
  for(const c of ch){ s.set(c,off); off+=c.length; }
  return encodeWAV(s, audioCtx.sampleRate);
}

async function reproducir(blob){
  if (!blob) return;
  audioEl.src = URL.createObjectURL(blob);
  try { await audioEl.play(); }
  catch { infoEl.textContent = "Grabado ‚úÖ. Toca Play para escuchar."; }
}

/* ===== Loop principal ===== */
let idx=0, list=[];

async function ciclo(){
  running = true;
  abortNow = false;
  btnStop.disabled = false;
  btnStart.disabled = true;

  list = buildList(modeEl.value);
  idx = 0;
  setProgress(0);

  while(running){
    let talkSecs = Number(talkSecsEl.value || 2.5);
    let listenSecs = Number(listenSecsEl.value || 3.0);
    const item = list[idx % list.length];

    let itemText = "";

    if(item.type === "pair"){
      talkSecs = Number(talkPairSecsEl.value || 4.5);
      listenSecs = Number(listenPairSecsEl.value || 5.0);
      wordOverlay.innerHTML = renderPair(item.a, item.b);
      infoEl.textContent = "Di primero la izquierda y luego la derecha‚Ä¶";
      itemText = `${item.a} -> ${item.b}`;
    } else {
      wordOverlay.textContent = item.a;
      infoEl.textContent = "Di la palabra ahora‚Ä¶";
      itemText = item.a;
    }

    // guardar evento (sin audio, solo registro)
    session.patientCode = (patientCodeEl.value || "").trim();
    session.events.push({
      ts: new Date().toISOString(),
      mode: modeEl.value,
      itemText,
      talkSecs,
      listenSecs
    });
    saveSession();

    // grabar
    infoEl.textContent = "Grabando‚Ä¶ üéôÔ∏è";
    setProgress(0);
    const talkMs = Math.round(talkSecs * 1000);
    const progressTask = runProgress(talkMs);
    const wav = await grabarWav(talkMs);
    await progressTask;

    if (!running || abortNow) break;
    if (!wav) break;

    // reproducir
    infoEl.textContent = "Escuchando tu voz ‚ñ∂Ô∏è";
    setProgress(0);
    await reproducir(wav);

    const listenMs = Math.round(listenSecs * 1000);
    await runProgress(listenMs);
    if (!running || abortNow) break;

    idx++;
    setProgress(0);
  }

  stopRecorderChain();
  setProgress(0);
  infoEl.textContent = "Detenido.";
  btnStop.disabled = true;
  btnStart.disabled = false;
}

/* ===== Botones ===== */
btnPerm.onclick = pedirMicrofono;

btnStart.onclick = async () => {
  if(!stream || !audioCtx){
    infoEl.textContent = "Primero pulsa 'Permitir micr√≥fono'.";
    return;
  }
  try{ await audioCtx.resume(); }catch{}
  ciclo();
};

btnStop.onclick = () => {
  running = false;
  abortNow = true;
  stopRecorderChain();
  setProgress(0);
  infoEl.textContent = "Deteniendo‚Ä¶";
};

btnExport.onclick = exportSession;
btnResetSession.onclick = resetSession;

btnSavePatient.onclick = savePatient;
btnClearPatient.onclick = clearPatient;

/* ===== C√°mara frontal ===== */
const cam = document.getElementById("cam");
const camOn = document.getElementById("camOn");
const camOff = document.getElementById("camOff");
let camStream=null;

camOn.onclick = async () => {
  try{
    camStream = await navigator.mediaDevices.getUserMedia({ video:{facingMode:"user"}, audio:false });
    cam.srcObject = camStream;
    camOn.disabled = true;
    camOff.disabled = false;
  } catch(e){
    infoEl.textContent = "No se pudo encender la c√°mara. Revisa permisos.";
  }
};

camOff.onclick = () => {
  if(camStream){
    camStream.getTracks().forEach(t=>t.stop());
    camStream=null;
    cam.srcObject=null;
  }
  camOn.disabled=false;
  camOff.disabled=true;
};

/* ===== Init ===== */
loadPatient();
loadSession();
session.patientCode = (patientCodeEl.value || "").trim();
saveSession();
</script>

</div>
</body>
</html>









