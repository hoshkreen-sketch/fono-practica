<script>
const palabras = [
  "pa","pe","pi","po","pu",
  "aba","obo","ubu","ebe","ibi",
  "pasa","basa","pesa","mesa","pala","bala",
  "pudo","mudo","bata","bote","buzo","bebé","bicho","billete"
];

let stream = null, i = 0, activo = false;

const word = document.getElementById("word");
const info = document.getElementById("info");
const audio = document.getElementById("audio");
const btnStart = document.getElementById("start");
const btnStop = document.getElementById("stop");

function esperar(ms){ return new Promise(r => setTimeout(r, ms)); }

function elegirMimeType() {
  const opciones = [
    "audio/mp4;codecs=mp4a.40.2", // iPhone suele soportar esto
    "audio/mp4",
    "audio/aac",
    "audio/webm;codecs=opus",
    "audio/webm"
  ];
  for (const t of opciones) {
    if (window.MediaRecorder && MediaRecorder.isTypeSupported && MediaRecorder.isTypeSupported(t)) {
      return t;
    }
  }
  return ""; // deja que el navegador elija
}

async function pedirMicrofono(){
  try {
    stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    info.textContent = "Micrófono listo ✅";
    btnStart.disabled = false;
  } catch (e) {
    info.textContent = "Error al pedir micrófono: " + (e?.message || e);
  }
}

async function grabarUnaVez(duracionMs){
  return new Promise((resolve, reject) => {
    try {
      const mimeType = elegirMimeType();
      const chunks = [];

      const rec = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

      rec.ondataavailable = (e) => {
        if (e.data && e.data.size > 0) chunks.push(e.data);
      };

      rec.onerror = (e) => reject(e.error || e);

      rec.onstop = () => {
        try {
          const tipoFinal = rec.mimeType || (chunks[0] && chunks[0].type) || "audio/mp4";
          const blob = new Blob(chunks, { type: tipoFinal });
          resolve({ blob, tipoFinal, size: blob.size });
        } catch (err) {
          reject(err);
        }
      };

      rec.start();
      setTimeout(() => {
        try { rec.stop(); } catch (err) { reject(err); }
      }, duracionMs);

    } catch (err) {
      reject(err);
    }
  });
}

async function ciclo(){
  while (activo) {
    const p = palabras[i % palabras.length];
    word.textContent = p;

    info.textContent = "Di la palabra ahora…";
    await esperar(400); // mini-pausa para prepararte

    try {
      // 1) grabar
      const { blob, tipoFinal, size } = await grabarUnaVez(2500);

      if (!size || size < 500) {
        info.textContent = "Grabación muy corta/vacía. Revisa permisos o prueba con audífonos.";
        await esperar(1200);
        i++;
        continue;
      }

      // 2) reproducir
      const url = URL.createObjectURL(blob);
      audio.src = url;

      info.textContent = "Reproduciendo tu voz ▶️";
      try {
        await audio.play(); // puede fallar si iOS bloquea autoplay
      } catch (e) {
        info.textContent = "Toca Play para escuchar (iPhone bloqueó autoplay).";
      }

      // espera un poco para que alcances a escuchar
      await esperar(3000);

    } catch (e) {
      info.textContent = "Error: " + (e?.message || e);
      await esperar(1500);
    }

    i++;
  }

  info.textContent = "Detenido.";
}

document.getElementById("perm").onclick = pedirMicrofono;

btnStart.onclick = () => {
  if (!stream) {
    info.textContent = "Primero pulsa 'Permitir micrófono'.";
    return;
  }
  activo = true;
  btnStop.disabled = false;
  btnStart.disabled = true;
  ciclo();
};

btnStop.onclick = () => {
  activo = false;
  btnStop.disabled = true;
  btnStart.disabled = false;
};
</script>
